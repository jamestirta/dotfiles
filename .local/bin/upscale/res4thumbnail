#!/usr/bin/dash
[ -n "$1" ] && {
  img=/tmp/.res4thumbnail-img ; scale=/tmp/.res4thumbnail-scale ; imgcat=$( cat $img ) ; scalecat=$( cat $scale ) ; upndownscale(){ waifu2xauto "$1" "$2" && res720 "$( cleanpng "$1" )"'-hd.png' && sq "$( cleanpng "$1" )"'-hd-resized.png';} ; success(){ echo "$1 has been upscaled $2x.";}
  echo "$1" > "$img" && getres "$1" | frawk '{print int(720/$1 + 0.99)}' > "$scale" &&{
    [ 2 -gt "$scalecat" ] && echo "'$1' need not be upscaled" && res720 "$imgcat" && exit 0;}||{
    [ 3 -gt "$scalecat" ] && upscale=2 && upndownscale "$imgcat" $upscale && success "$imgcat" $upscale && exit 0;}||{
    [ 5 -gt "$scalecat" ] && upscale=4 && upndownscale "$imgcat" $upscale && success "$imgcat" $upscale && exit 0;}||{
    [ 9 -gt "$scalecat" ] && upscale=8 && upndownscale "$imgcat" $upscale && success "$imgcat" $upscale && exit 0;}||{
    [ 17 -gt "$scalecat" ] && upscale=16 && upndownscale "$imgcat" $upscale && success "$imgcat" $upscale && exit 0;};}||{
echo "Usage: res4thumbnail <image>";}
